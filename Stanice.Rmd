---
title: "Stanice"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    css: 'styles.css'
    theme: bootstrap
runtime: shiny
---

```{r global, include=FALSE}
rm(list = ls())
library(shiny)
library(flexdashboard)
library(dplyr)
library(dygraphs)
library(ggplot2)
library(plotly)
library(data.table)

#install.packages('bit64')

.datadir <- "C:\\Users\\Georgievova\\Documents\\meteo_LD\\stanice_data"
tfrom <- format((as.Date(format(Sys.time(), "%Y%m%d%H%M"), format = "%Y%m%d%H%M")-30), format = "%Y%m%d%H%M")

zkr <- read.table(file.path(.datadir, "zkr_seznam.txt"), header = TRUE, sep = " ")

stanice <- readRDS(file.path(.datadir, "denni\\stanice_dm.rds")) 

stanice_updt <- fread(paste0("http://meteo.libordanes.cz/d/d.aspx?usr=po&pwd=pojist%2B1&id=23&tfrom=", tfrom, "&tto=", format(Sys.time(), "%Y%m%d%H%M")),
                         header = FALSE, sep = ",", col.names = c("ID", "SIGNAL_KEY", "DTM", "value"), colClasses = c("character", "factor", "POSIXct", "numeric"))
stanice_updt$DTM <- as.POSIXct(stanice_updt$DTM, format = "%Y%m%d%H%M")
stanice_updt <- merge(stanice_updt, zkr, by = "SIGNAL_KEY")
stanice_updt <- stanice_updt %>% filter(!ID %in% c("VURV Oldrichov", "Bulhary1", "Bulhary2", "Bulhary3"))

choices.var <- unique(stanice_updt$SIGNAL_KEY)
names(choices.var) <- as.character(unique(stanice_updt$SIG_NAME))

# bulhary <- read.table(file.path(.datadir,"Bulhary2.txt"), header = TRUE, sep = ";", col.names = c("DTM", "P10m", "P1h", "P24h"), dec=",", colClasses = c("factor", "numeric", "numeric", "numeric"))
bulhary <- read.table(file.path(.datadir,"dlouhodb\\bulhary.txt"), header = TRUE, sep = "", colClasses = c("Date", "numeric", "numeric"))
oracov <- read.table(file.path(.datadir,"dlouhodb\\oracov.txt"), header = TRUE, sep = "", colClasses = c("Date", "numeric", "numeric"))

#prejmenuj dle zkr_seznam!!
vuv <- read.table(file.path(.datadir,"libor_d_new\\VUV.txt"), header = TRUE, sep = ";", dec=",", col.names = c("DTM", "T", "V", "S", "R", "Y", "H1", "SRA10M", "SRA1H", "SRA24H", "TH"))
vuv$DTM <- as.POSIXct(vuv$DTM, format = "%d.%m.%Y %H:%M:%OS")

# stanice <- read.table(file.path(.datadir, "meteo_seznam.csv"), header = TRUE, sep = ",")

```

Baštýnský potok
===================================== 

```{r bastynsky: reactions}

bastynsky <- reactive({

  if(input$entry.var == 'P'){
    bastynsky <- stanice[stanice$ID == "bastynsky",]  %>% select(-TMP, -month.TMP, value = P, month.val = month.P)
    # bastynsky.var <- stanice %>%  filter(ID == "bastynsky") %>% select(-P, -month.P)
  }else{
    bastynsky <- stanice[stanice$ID == "bastynsky",] %>% select(-P, -month.P, value = TMP, month.val = month.TMP)
    }
  
  return(bastynsky)
})

```

Row {data-height=500}
-------------------------------------

### Graf1 {data-width=450}

```{r bastynsky: panel}

absolutePanel(class = "panel panel-default", draggable = FALSE,
              top = "0%", left = '0%', 
              right = "auto", bottom = 'auto',
              width = '17%', height = "10",
              style = "opacity: 0.8; z-index: 10;",
              # style = "opacity: 1; style = z-index: 400",
        wellPanel(
          radioButtons("entry.var", label = "Zvolte proměnnou:", 
                       choices = c("Teplota" = "TMP",
                                   "Srážky" = "P"), selected = "TMP"),
          selectInput("entry.year", label = "Zvolte rok:",
                      choices = seq(1961,2015,1))
          )
)

```


```{r bastynsky: g1}
renderPlotly({
  
  bastynsky <- bastynsky()
  
  bastynsky.yt <- bastynsky %>% filter(year(DTM) == input$entry.year) #%>% group_by(month) %>% summarise(month.val=mean(month.val))
  
  bastynsky.t <- bastynsky %>% select(value, DTM, month) %>% group_by(month) %>% 
    mutate(
      Q10 = quantile(value, probs = 0.1), 
      Q20 = quantile(value, probs = 0.2), 
      Q30 = quantile(value, probs = 0.3),
      Q40 = quantile(value, probs = 0.4), 
      Q50 = quantile(value, probs = 0.5),
      Q60 = quantile(value, probs = 0.6), 
      Q70 = quantile(value, probs = 0.7),
      Q80 = quantile(value, probs = 0.8), 
      Q90 = quantile(value, probs = 0.9)) %>% select(-DTM, -value) %>% ungroup
  
  bas.t <-
    ggplot()+
    # geom_line(data = bastynsky.yt, aes(DTM, value), color="red")+
    # scale_x_continuous(breaks=/12)
    # 
    # ggplot()+
    # geom_line(data = bastynsky.yt, aes(month, month.val), color = "red")+
    geom_ribbon(data = bastynsky.t, aes(month, ymin=Q10, ymax=Q90), fill = 'orange', alpha=0.2)+
    geom_ribbon(data = bastynsky.t, aes(month, ymin=Q20, ymax=Q80), fill = 'green', alpha=0.2)+
    geom_ribbon(data = bastynsky.t, aes(month, ymin=Q30, ymax=Q70), fill = 'blue', alpha=0.2)+
    geom_ribbon(data = bastynsky.t, aes(month, ymin=Q40, ymax=Q60), fill = 'red', alpha=0.5)+
    geom_line(data = bastynsky.t, aes(month, Q50))+
    theme_minimal()+
    scale_x_continuous(breaks=c(1:12))
    # scale_x_continuous(sec.axis = sec_axis(trans = ~.*30, breaks=c(1:12)))

  
  # 
  # 
  # ggplot()+
  #   geom_line(data = bastynsky.yt, aes(DTM, TMP), color = "red")+
  #   scale_x_date(name = "Month", breaks = c(1:12))+
  #   geom_ribbon(data = bastynsky.t, aes(month, ymin=TMP10, ymax=TMP90), fill = 'blue', alpha=0.1)+
  #   geom_ribbon(data = bastynsky.t, aes(month, ymin=TMP30, ymax=TMP70), fill='red',alpha=0.1)+
  #   geom_line(data = bastynsky.t, aes(month, TMP50))+
  #   theme_minimal()
  # 
  #   
  #   ggplot()+
  #   geom_ribbon(data = bastynsky.t, aes(month, ymin=TMP10, ymax=TMP90), fill = 'blue', alpha=0.1)+
  #   geom_ribbon(data = bastynsky.t, aes(month, ymin=TMP30, ymax=TMP70), fill='red',alpha=0.1)+
  #   geom_line(data = bastynsky.t, aes(month, TMP50))+
  #   theme_minimal()+
  #   scale_x_continuous(breaks=c(1:12))
  
  ggplotly(bas.t)
  
})
```


Row {data-height=500}
-------------------------------------

### Graf2 {data-width=500}

```{r bastynsky g2 panel}

absolutePanel(class = "panel panel-default", draggable = FALSE,
              top = "0%", left = '0%', 
              right = "auto", bottom = 'auto',
              width = '20%', height = "10",
              style = "opacity: 0.8; z-index: 10;",
        wellPanel(
            selectizeInput("years", label = "Zadejte roky:",
                           choices = seq(1961,2015,1), multiple = TRUE, selected = 1961, size = 55
                           )
            )
          )

```


```{r bastynsky g2}
renderPlotly({
bastynsky <- bastynsky()

# bastynsky.g2a <- bastynsky %>% mutate(year = year(DTM)) %>% group_by(year) %>% mutate(mean.h = mean(abs(month.val))) %>% mutate(cumsum.h = cumsum(abs(mean.h)))

bastynsky.g2 <- bastynsky %>% mutate(year = year(DTM)) %>% filter(year == c(input$years)) %>% group_by(year) %>% select(month.val, month, year) %>% mutate(cumsum.val = cumsum(abs(month.val)))

bas.t2 <- ggplot() + 
  # geom_line(data = bastynsky.g2a, aes(month, cumsum.h))+
  geom_line(data = bastynsky.g2, aes(month, cumsum.val, colour=factor(year)))+
  scale_x_continuous(breaks=c(1:12))+
  theme_minimal()+
  scale_colour_brewer(palette = "Set1", type = "div")

ggplotly(bas.t2) 
})
```


Bulhary
===================================== 

Row 
-------------------------------------

```{r}
renderPlotly({
  
  # bulhary.t <- bulhary %>% select(TMP, DTM) %>% mutate(lwr = TMP-abs(TMP*0.5), uppr = TMP+abs(TMP*0.5))
  
  bulhary.t <- bulhary %>% select(TMP, DTM) %>% 
    mutate(month = month(DTM)) %>% group_by(month) %>% 
    mutate(
      TMP10 = quantile(TMP, probs = 0.1), 
      TMP30 = quantile(TMP, probs = 0.3),
      TMP50 = quantile(TMP, probs = 0.5),
      TMP70 = quantile(TMP, probs = 0.7),
      TMP90 = quantile(TMP, probs = 0.9)) %>% select(-DTM, -TMP)
  
  bul.t <- ggplot(bulhary.t)+
    geom_ribbon(aes(month, ymin=TMP10, ymax=TMP90), fill = 'blue', alpha=0.1)+
    geom_ribbon(aes(month, ymin=TMP30, ymax=TMP70), fill='red',alpha=0.1)+
    geom_line(aes(month, TMP50))+
    theme_minimal()+
    scale_x_continuous(breaks=c(1:12))
  
  # bul.t
  
  ggplotly(bul.t)

})
```


```{r}
# renderDygraph({
#   
#   bulhary.n <- bulhary %>% select(P, DTM) %>% mutate(lwr10 = P*0.9, upper10 = P*1.1)
#   test <- bulhary.n[1:500,]
#   test <- test %>% select(-DTM, lwr10, P, upper10)
# 
#   # RangeMin <- min(ts.bilance$P)-0.5
#   # RangeMax <- max(ts.bilance$P)+0.5
#   
#   # ts.bulhary <- xts::xts(bulhary.n, order.by = bulhary.n$DTM)
#   ts.bulhary <- ts(bulhary.n, start = lubridate::decimal_date(as.Date("1961-01-01")), frequency = 1)
# 
#   # test.ts <- xts::xts(test, order.by = test$DTM)
#   tes.ts <- ts(test, start = lubridate::decimal_date(as.Date("1961-01-01")), frequency = 1)
#   
#   dygraph(test.ts, main = "Denní srážky", xlab = "Čas") %>%
#   dySeries("P") %>% 
#   dySeries(c("lwr10", "P", "upper10")) %>% 
# #  dyAxis("y", valueRange = c(RangeMin, RangeMax)) %>%  
#   dyRangeSelector() %>% 
#   dyCrosshair(direction = "vertical")
# })

```

Row 
-------------------------------------

```{r}
renderPlotly({
  
  # bulhary.p <- bulhary %>% select(P, DTM) %>% mutate(lwr = P-abs(P*0.3), uppr = P+abs(P*0.3))
  # 
  # p <- ggplot(bulhary.p, aes(DTM))+
  #   geom_ribbon(aes(ymin=P*0.7, ymax=P*1.3), fill="red", alpha = 0.6)+
  #   geom_line(aes(y=P))+theme_minimal()
  # 
  # p
  # 
  
  bulhary.p <- bulhary %>% select(P, DTM) %>% 
    mutate(month = month(DTM)) %>% group_by(month) %>% 
    mutate(
      P10 = quantile(P, probs = 0.1), 
      P20 = quantile(P, probs = 0.2),
      P30 = quantile(P, probs = 0.3),
      P40 = quantile(P, probs = 0.4),
      P50 = quantile(P, probs = 0.5),
      P60 = quantile(P, probs = 0.6),
      P70 = quantile(P, probs = 0.7),
      P80 = quantile(P, probs = 0.8),
      P90 = quantile(P, probs = 0.9)) %>% select(-DTM, -P)
  
  bul.p <- ggplot(bulhary.p)+
    geom_ribbon(aes(month, ymin=P10, ymax=P90), fill = 'orange', alpha=0.2)+
    geom_ribbon(aes(month, ymin=P20, ymax=P80), fill='green',alpha=0.2)+
    geom_ribbon(aes(month, ymin=P30, ymax=P70), fill='blue',alpha=0.2)+
    geom_ribbon(aes(month, ymin=P40, ymax=P60), fill='red',alpha=0.5)+
    geom_line(aes(month, P50))+
    theme_minimal()+
    scale_x_continuous(breaks=c(1:12))
  
  # bul.p
  
  ggplotly(bul.p)

})

```


Kojetický potok
===================================== 

```{r}

```


Lišany
===================================== 


Merboltický potok
===================================== 

### Graf3 {data-width=500}

```{r merboltice g3 panel}

absolutePanel(class = "panel panel-default", draggable = FALSE,
              top = "0%", left = '0%', 
              right = "auto", bottom = 'auto',
              width = '20%', height = "10",
              style = "opacity: 0.8; z-index: 10;",
        wellPanel(
            selectInput("entry.variable", label = "Zvolte promennou:",
                           choices = choices.var, selected = "H1")
            )
          )

```

```{r merboltice g3}

renderDygraph({
  
  merboltice.g3 <- stanice_updt %>% filter(SIGNAL_KEY == input$entry.variable, ID == "Merboltice p") %>% select(DTM, value)
  merboltice.g3 <- xts::xts(merboltice.g3, order.by = merboltice.g3$DTM)

  dygraph(merboltice.g3, xlab = "Čas") %>%  
  dyRangeSelector() %>% 
  dyCrosshair(direction = "vertical")
  
})

```


Oráčov
===================================== 

Row 
-------------------------------------

```{r}
renderPlotly({
  
  oracov.t <- oracov %>% select(TMP, DTM) %>% 
    mutate(month = month(DTM)) %>% group_by(month) %>% 
    mutate(
      TMP10 = quantile(TMP, probs = 0.1), 
      TMP30 = quantile(TMP, probs = 0.3),
      TMP50 = quantile(TMP, probs = 0.5),
      TMP70 = quantile(TMP, probs = 0.7),
      TMP90 = quantile(TMP, probs = 0.9)) %>% select(-DTM, -TMP)
  
  orac.t <- ggplot(oracov.t)+
    geom_ribbon(aes(month, ymin=TMP10, ymax=TMP90), fill = 'blue', alpha=0.1)+
    geom_ribbon(aes(month, ymin=TMP30, ymax=TMP70), fill='red',alpha=0.1)+
    geom_line(aes(month, TMP50))+
    theme_minimal()+
    scale_x_continuous(breaks=c(1:12))
  
  # orac.t
  
  ggplotly(orac.t)

})
```


Row 
-------------------------------------

```{r}
renderPlotly({
  
  oracov.p <- oracov %>% select(P, DTM) %>% 
    mutate(month = month(DTM)) %>% group_by(month) %>% 
    mutate(
      P10 = quantile(P, probs = 0.1), 
      P20 = quantile(P, probs = 0.2),
      P30 = quantile(P, probs = 0.3),
      P40 = quantile(P, probs = 0.4),
      P50 = quantile(P, probs = 0.5),
      P60 = quantile(P, probs = 0.6),
      P70 = quantile(P, probs = 0.7),
      P80 = quantile(P, probs = 0.8),
      P90 = quantile(P, probs = 0.9)) %>% select(-DTM, -P)
  
  orac.p <- ggplot(oracov.p)+
    geom_ribbon(aes(month, ymin=P10, ymax=P90), fill = 'orange', alpha=0.2)+
    geom_ribbon(aes(month, ymin=P20, ymax=P80), fill='green',alpha=0.2)+
    geom_ribbon(aes(month, ymin=P30, ymax=P70), fill='blue',alpha=0.2)+
    geom_ribbon(aes(month, ymin=P40, ymax=P60), fill='red',alpha=0.5)+
    geom_line(aes(month, P50))+
    theme_minimal()+
    scale_x_continuous(breaks=c(1:12))
  
  # orac.p
  
  ggplotly(orac.p)

})

```


Podhora
===================================== 

Poledník
===================================== 

Přepeře
===================================== 

Račinka
===================================== 


Svitavka
=====================================


Teplica
=====================================


VÚV meteo
=====================================

Row {data-hight=500}
-------------------------------------

```{r}
renderPlotly({
  
  vuv.t <- vuv %>% select(T, DTM) %>% 
    muTte(month = month(DTM)) %>% group_by(month) %>% 
    muTte(
      T10 = quantile(T, probs = 0.1), 
      T30 = quantile(T, probs = 0.3),
      T50 = quantile(T, probs = 0.5),
      T70 = quantile(T, probs = 0.7),
      T90 = quantile(T, probs = 0.9)) %>% select(-DTM, -T)
  
  vt <- ggplot(vuv.t)+
    geom_ribbon(aes(month, ymin=T10, ymax=T90), fill = 'blue', alpha=0.1)+
    geom_ribbon(aes(month, ymin=T30, ymax=T70), fill='red',alpha=0.1)+
    geom_line(aes(month, T50))+
    theme_minimal()+
    scale_x_continuous(breaks=c(1:12))
  
  # orac.t
  
  ggplotly(vt)

})
```

Row {.tabset data-hight=500}
-------------------------------------

### Teplota vody [°C]

```{r}
renderDygraph({
  
  vuv.TH <- vuv %>% select(TH, DTM)
  vuv.TH <- xts::xts(vuv.TH, order.by = vuv.TH$DTM)

  dygraph(vuv.TH, xlab = "Čas") %>%  
  dyRangeSelector() %>% 
  dyCrosshair(direction = "vertical")
  
})
```

### Rychlost větru [m/s]

```{r}
renderDygraph({
  
  vuv.V <- vuv %>% select(V, DTM)
  vuv.V <- xts::xts(vuv.V, order.by = vuv.V$DTM)

  dygraph(vuv.V, xlab = "Čas") %>%  
  dyRangeSelector() %>% 
  dyCrosshair(direction = "vertical")
  
})
```

### Sluneční svit [W/m2]

```{r}
renderDygraph({
  
  vuv.Pyr <- vuv %>% select(Y, DTM)
  vuv.Pyr <- xts::xts(vuv.Pyr, order.by = vuv.Pyr$DTM)

  dygraph(vuv.Pyr, xlab = "Čas") %>%  
  dyRangeSelector() %>% 
  dyCrosshair(direction = "vertical")
  
})
```

### Vlhkost vzduchu ve 2m [%R.v.]

```{r}
renderDygraph({
  
  vuv.R <- vuv %>% select(R, DTM)
  vuv.R <- xts::xts(vuv.R, order.by = vuv.R$DTM)

  dygraph(vuv.R, xlab = "Čas") %>%  
  dyRangeSelector() %>% 
  dyCrosshair(direction = "vertical")
  
})
```