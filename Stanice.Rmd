---
title: "Stanice"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: bootstrap
    css: 'styles.css'
runtime: shiny
---

```{r global, include=FALSE}
rm(list = ls())
library(shiny)
library(flexdashboard)
library(dplyr)
library(dygraphs)
library(ggplot2)
library(plotly)
library(data.table)

#install.packages('bit64')

.datadir <- "s:\\SOUKROMÉ ADRESÁŘE\\Irina\\meteo_LD\\stanice_data"

#denni a mesicni data
stanice <- readRDS(file.path(.datadir, "denni\\stanice.rds")) 

#data za poslednich 30 dni
stanice_updt <- readRDS(file.path(.datadir, "libor_d_new\\stanice_updt31072018.rds")) #paste0("libor_d_new\\stanice_updt", format(Sys.time(), "%d%m%Y"), ".rds")

# ch <- c("Baštýnský potok", "Bulhary", "Olešná")
# choices.id <- sort(c(unique(stanice_updt$ID), ch))
choices.id <- sort(unique(stanice_updt$ID))
```

```{r reactions}

dta <- reactive({
  
  stanice <- stanice %>% filter(ID == input$entry.id)
  
  stanice_updt <- stanice_updt %>% filter(ID == input$entry.id)
  choices.updt <- as.character(unique(stanice_updt$SIGNAL_KEY))
  names(choices.updt) <- as.character(unique(stanice_updt$SIG_NAME))

  if(input$entry.var == 'P'){
    stanice <- stanice %>% select(-TMP, -month.TMP, value = P, month.val = month.P)
    # bastynsky.var <- stanice %>%  filter(ID == "bastynsky") %>% select(-P, -month.P)
  }else{
    stanice <- stanice %>% select(-P, -month.P, value = TMP, month.val = month.TMP)
    }
  
  return(list(stanice = stanice, stanice_updt = stanice_updt, choices.updt = choices.updt))
})

```

Column {.sidebar data-width=400}
-----------------------------------------------------------------------

```{r sidepanel}

wellPanel(
  radioButtons("entry.id", label = "Stanice Pojizeří:",
               choices = choices.id, selected = "VÚV meteo")
          )

hr()

wellPanel(
  radioButtons("entry.var", label = "Zvolte proměnnou:", 
                       choices = c("Teplota" = "TMP",
                                   "Srážky" = "P"), selected = "TMP"),
  selectizeInput("entry.year", label = "Zadejte roky:",
                           choices = seq(1961,2015,1), multiple = TRUE, selected = 1961, size = 55
                 )
  )


wellPanel(
  renderUI({
  selectInput("entry.var.updt", label = "Zvolte promennou:",
              choices = dta()$choices.updt)
  })
  )

```

Row
-----------------------------------------------------------------------

### Dlouhodobé údaje

```{r g1}
renderPlotly({
  
  dta <- dta()$stanice
  
  dta.yt <- dta %>% mutate(year = year(DTM)) %>% filter(year %in% input$entry.year) %>% 
                  group_by(year) %>% mutate(month = seq(1,12,11/(n()-1)))
  
  # bastynsky.yt$month <- seq(1,12,11/(nrow(bastynsky.yt)-1))
  
  dta.t <- dta %>% select(value, DTM, month) %>% group_by(month) %>% 
    mutate(
      Q10 = quantile(value, probs = 0.1), 
      Q20 = quantile(value, probs = 0.2), 
      Q30 = quantile(value, probs = 0.3),
      Q40 = quantile(value, probs = 0.4), 
      Q50 = quantile(value, probs = 0.5),
      Q60 = quantile(value, probs = 0.6), 
      Q70 = quantile(value, probs = 0.7),
      Q80 = quantile(value, probs = 0.8), 
      Q90 = quantile(value, probs = 0.9)) %>% select(-DTM, -value) %>% ungroup
  
  
  g1 <-
    ggplot()+
    geom_line(data = dta.yt, aes(month, value, group = year, color=factor(year)), alpha = 0.95)+ #text=sprintf("DTM: %s<br>hodnota: %s", DTM, round(value, 2)),
    geom_ribbon(data = dta.t, aes(month, ymin=Q10, ymax=Q90), fill = 'orange', alpha=0.2)+
    geom_ribbon(data = dta.t, aes(month, ymin=Q20, ymax=Q80), fill = 'green', alpha=0.2)+
    geom_ribbon(data = dta.t, aes(month, ymin=Q30, ymax=Q70), fill = 'blue', alpha=0.2)+
    geom_ribbon(data = dta.t, aes(month, ymin=Q40, ymax=Q60), fill = 'red', alpha=0.5)+
    geom_line(data = dta.t, aes(month, Q50))+
    theme_minimal()+
    scale_x_continuous(breaks=c(1:12))+
    labs(color = "Rok", x = "Měsíce", y = "Hodnota")
  # +ylim(min(bastynsky$value), max(bastynsky$value))

  
  ggplotly(g1) #, tooltip = "text"
  
})
```


Row {.tabset}
-----------------------------------------------------------------------

### Data za posledních 30 dní

```{r g2}

renderDygraph({

  stanice_updt <- dta()$stanice_updt
  stanice_updt <- stanice_updt %>% filter(SIGNAL_KEY == input$entry.var.updt) %>% select(DTM, value)
  
  stanice.g <- xts::xts(stanice_updt, order.by = stanice_updt$DTM)

  dygraph(stanice.g, xlab = "Čas") %>%  
  dyRangeSelector() %>% 
  dyCrosshair(direction = "vertical")
  
})

```

### Kumulutavní srážky

```{r g3}
renderPlotly({

stanice <- stanice %>%  filter(ID == input$entry.id) %>% select(-TMP, -month.TMP, value = P, month.val = month.P)
  
# stanice.t <- stanice %>% mutate(year = year(DTM)) %>% filter(year %in% input$entry.year) %>% group_by(year) %>% select(month.val, month, year) %>%
#   mutate(cumsum.val = cumsum(month.val))

stanice.t <- stanice %>% mutate(year = year(DTM)) %>% filter(year %in% input$entry.year) %>% 
                         group_by(year) %>% select(DTM, value, year) %>% mutate(cumsum.val = cumsum(value)) %>% mutate(month = seq(1,12,11/(n()-1)))

st2 <- ggplot() + 
  geom_line(data = stanice.t, aes(month, cumsum.val, group = year, colour=factor(year), text=sprintf("DTM: %s<br>hodnota: %s", DTM, round(cumsum.val, 2))))+
  theme_minimal()+
  scale_colour_brewer(palette = "Set1", type = "div")+
  scale_x_continuous(breaks=c(1:12))+
  labs(color = "Rok", x = "Měsíce", y = "[mm]")

# st2 <- ggplot() + 
#   geom_line(data = stanice.t, aes(month, cumsum.val, group = year, colour=factor(year)))+
#   scale_x_continuous(breaks=c(1:12))+
#   theme_minimal()+
#   scale_colour_brewer(palette = "Set1", type = "div")+
#   labs(color = "Rok", x = "Měsíce", y = "[mm]")

ggplotly(st2, tooltip = "text") 
})
```

